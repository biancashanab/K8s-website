<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2>File History</h2>
      <p class="text-muted">View all processed files and their entity extraction results</p>
      
      <!-- Debug Information (hidden in production) -->
      <div *ngIf="!environment?.production" class="debug-panel mb-3 p-2 border bg-light small">
        <strong>Debug Info:</strong> API URL: {{apiUrl}}
        <button class="btn btn-sm btn-outline-secondary ms-2" (click)="checkApiHealth()">Check API Health</button>
        <div *ngIf="apiHealthStatus !== null">
          API Health: <span [ngClass]="{'text-success': apiHealthStatus, 'text-danger': !apiHealthStatus}">
            {{apiHealthStatus ? 'Connected' : 'Disconnected'}}
          </span>
        </div>
      </div>
      
      <!-- Loading State -->
      <div *ngIf="loading" class="text-center p-3">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading data...</p>
      </div>
      
      <!-- Error Message -->
      <div *ngIf="error" class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ error }}
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-danger" (click)="loadFileHistory()">
            <i class="bi bi-arrow-clockwise me-1"></i> Retry
          </button>
        </div>
      </div>
      
      <!-- File List Table -->
      <div *ngIf="!loading && !error">
        <div *ngIf="files.length === 0" class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <p class="mb-0">No files found in history. Upload a file to get started.</p>
          <div class="mt-3">
            <a routerLink="/upload" class="btn btn-primary">Upload New File</a>
          </div>
        </div>
        
        <div *ngIf="files.length > 0" class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-light">
              <tr>
                <th>File Name</th>
                <th>Upload Date</th>
                <th>File Type</th>
                <th>Processing Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let file of files">
                <td>{{ file.fileName }}</td>
                <td>{{ file.uploadTimestamp | date:'medium' }}</td>
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-primary': file.fileType === 'pdf',
                    'bg-success': file.fileType === 'txt',
                    'bg-info': file.fileType === 'docx' || file.fileType === 'doc',
                    'bg-secondary': file.fileType === 'Unknown'
                  }">
                    {{ file.fileType }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-success': file.processingStatus === 'Completed',
                    'bg-warning text-dark': file.processingStatus === 'Processing',
                    'bg-danger': file.processingStatus === 'Failed',
                    'bg-secondary': file.processingStatus === 'Unknown'
                  }">
                    {{ file.processingStatus }}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-primary" (click)="viewEntityResults(file)" 
                          [disabled]="file.processingStatus !== 'Completed'">
                    <i class="bi bi-search me-1"></i> View Results
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Entity Results Modal -->
  <div *ngIf="selectedFile && entityResults" class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">
            <i class="bi bi-file-earmark-text me-2"></i>
            Entity Extraction Results - {{ selectedFile.fileName }}
          </h5>
          <button type="button" class="btn-close" (click)="clearSelection()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="entityResults.entities && entityResults.entities.length > 0">
            <h6 class="border-bottom pb-2">Extracted Entities:</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead class="table-light">
                  <tr>
                    <th>Entity Text</th>
                    <th>Category</th>
                    <th>Confidence Score</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let entity of entityResults.entities">
                    <td>{{ entity.text }}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'bg-primary': entity.category === 'Person',
                        'bg-success': entity.category === 'Location',
                        'bg-info': entity.category === 'Organization',
                        'bg-warning text-dark': entity.category === 'Date',
                        'bg-secondary': entity.category === 'Quantity' || entity.category === 'Number',
                        'bg-dark': entity.category === 'Event'
                      }">
                        {{ entity.category }}
                      </span>
                    </td>
                    <td>
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" 
                             [ngClass]="{
                               'bg-success': entity.confidenceScore >= 0.7,
                               'bg-warning': entity.confidenceScore >= 0.4 && entity.confidenceScore < 0.7,
                               'bg-danger': entity.confidenceScore < 0.4
                             }"
                             [style.width.%]="entity.confidenceScore * 100" 
                             [attr.aria-valuenow]="entity.confidenceScore * 100" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                          {{ (entity.confidenceScore * 100).toFixed(0) }}%
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div *ngIf="!entityResults.entities || entityResults.entities.length === 0" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No entities were found in this document.
          </div>
          
          <div *ngIf="entityResults.summary" class="mt-4">
            <h6 class="border-bottom pb-2">Document Summary:</h6>
            <div class="card">
              <div class="card-body">
                {{ entityResults.summary }}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="clearSelection()">Close</button>
          <a *ngIf="selectedFile.blobUrl" [href]="selectedFile.blobUrl" target="_blank" class="btn btn-primary">
            <i class="bi bi-download me-1"></i> Download Original
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Backdrop -->
  <div *ngIf="selectedFile && entityResults" class="modal-backdrop fade show"></div>
</div>
